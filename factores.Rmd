---
title: "Taller: R para Ciencia de Datos (Grupo de estudio) | Cap√≠tulo 15: Factores"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

# Factores

## Prerrequisitos

![](logo.png)    

1. Paquete `forcats` (*FactOR CATegorical variableS*) y otros de `tidyverse`:

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(forcats)
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)

```

O bien solo:

```{r eval=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
```




2. Clonar o descargar repositorio:

```{bash eval=FALSE, include=FALSE}
# M√©todo 1
git clone git@github.com:jstrappa/r4ds_taller_15_factores.git

# M√©todo 2
# TODO
```


## Introducci√≥n

### Taller: R para Ciencia de Datos (Grupo de estudio)

Presenta: **Jan Strappa** ([jansf.netlify.app](https://jansf.netlify.app))

Cap√≠tulo: **15. Factores** [https://es.r4ds.hadley.nz/factores.html](https://es.r4ds.hadley.nz/factores.html)



### ¬øQu√© es un factor?

> En estad√≠stica, una variable categ√≥rica es una variable que puede tomar uno de un n√∫mero limitado, y por lo general fijo, de posibles valores, asignando a cada unidad individual u otro tipo observaci√≥n a un grupo en particular o categor√≠a nominal sobre la base de alguna caracter√≠stica cualitativa.
> 
> [Wikipedia: Variable categ√≥rica](https://es.wikipedia.org/wiki/Variable_categ%C3%B3rica)


Ejemplos de variables categ√≥ricas:

- g√©nero
- pa√≠s, provincia, territorio
- empleo
- nacionalidad

**PREGUNTA: ¬øSe te ocurren otros ejemplos de variables categ√≥ricas? ¬øHas trabajado o trabajas con ellas? üí¨**


### Cadenas como factores: el debate 

[stringsAsFactors: An unauthorized biography](https://simplystatistics.org/posts/2015-07-24-stringsasfactors-an-unauthorized-biography/)

‚ÄòstringsAsFactors‚Äô es un argumento de la funci√≥n ‚Äòdata.frame()‚Äô. 
Por defecto, todas las cadenas se convierten a factores en R.

Algunes se preguntan:

> Why does stringsAsFactors not default to FALSE????

- Los factores sirven para codificar datos categ√≥ricos de forma √∫til para funciones de modelado. 
- En datos tabulares, generalmente una cadena = un dato categ√≥rico.
- Los an√°lisis estad√≠sticos tradicionales suelen usar ampliamente datos categ√≥ricos.


Controversia:

- Personas con trasfondo estad√≠stico tienden a usar cadenas como factores (`stringsAsFactors=TRUE` tiene sentido para ellas).
- Otras personas usan R para casos de uso no tradicionales, por ejemplo, cadenas como etiquetas (gen√©tica). (Estas son las personas que desear√≠an `stringsAsFactors=FALSE` por defecto üôã)

Actualmente, muchas funciones no realizan coerci√≥n de cadenas a factores, por ejemplo, `readr`^[https://peerj.com/preprints/3163/].


## Creando factores

```{r}

# Variable categ√≥rica: meses
x1 <- c("Dic", "Abr", "Ene", "Mar")

# Variable que contiene un dato con error de tipeo
x2 <- c("Dic", "Abr", "Eme", "Mar")

# El orden es alfab√©tico
sort(x1)

# Crear un factor: niveles
niveles_meses <- c(
  "Ene", "Feb", "Mar", "Abr", "May", "Jun",
  "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"
)

# Crear el factor
# (Si omites los niveles, se van a definir a partir de los datos en orden alfab√©tico)
y1 <- factor(x1, levels = niveles_meses)
```

Otro ejemplo:

```{r}

# Variable categ√≥rica: ¬øqu√© lenguajes de programaci√≥n sab√©s?
lenguajes <- c("R", "Python", "C#", "Julia")

# Crear un factor: niveles
niveles_lenguajes <- c(
  "R", "C", "C++", "C#", "Julia", "Python",
  "Ada", "Go", "Rust", "Octave", "MATLAB", "Java"
)

# Crear el factor
# (Si omites los niveles, se van a definir a partir de los datos en orden alfab√©tico)
lenguajes_factor <- factor(lenguajes, levels = niveles_lenguajes)

```





## Ventajas de usar factores


### Ventaja: ordenamiento

```{r}
# No es factor: orden alfab√©tico
print(sort(x1))

# Es factor: orden seg√∫n niveles definidos en el factor
print(sort(y1))

```


### Ventaja: advertencia si hay niveles mal escritos

```{r}
y2 <- parse_factor(x2, levels = niveles_meses)
# Warning: 1 parsing failure.
# row col           expected actual
#   3  -- value in level set    Eme
```

Ejemplo de lenguajes:

```{r}

# Datos con variantes para el lenguaje de programaci√≥n C#
lenguajes2 <- c("C-sharp", "Python", "C#", "Julia", "C Sharp", "Go", "Java", "C‚ôØ")

# parse_factor nos advierte
lenguajes2_factor <- parse_factor(lenguajes2, levels = niveles_lenguajes)
 
# Warning: 3 parsing failures.
# row col           expected  actual
#   1  -- value in level set C-sharp
#   5  -- value in level set C Sharp
#   7  -- value in level set Java  
```

(¬øC√≥mo hacemos para resolver esto? Lo veremos al final.)

### Se pueden definir niveles definidos en base a su aparici√≥n en los datos:

```{r}
f1 <- factor(x1, levels = unique(x1))

f2 <- x1 %>% factor() %>% fct_inorder()

levels(f2)
```


**PREGUNTA: ¬øSe pueden ordenar los niveles de otra forma? üí¨**

**Tip 1:**

Para ver todas las funciones de `forcats`^[http://fisher.stats.uwo.ca/faculty/aim/2018/9864/RNotebooks/08_factors/08_LectureNote_forcatsPackage_Nov18.html]:

```{r}
ls("package:forcats") %>% str_subset(., "^fct_")
```

**Tip 2: **

Pod√©s ver la ayuda de la funci√≥n que acabamos de usar con `?fct_inorder()`.

**SOLUCI√ìN:**

```{r solucion-orden}
#
#
# SPOILER
#
#
#
# S√≠, usando `fct_infreq()` o `fct_inseq()` (por frecuencia, o por secuencia num√©rica)
f3 <- x1 %>% factor() %>% fct_infreq()

levels(f3)
```

### Ejemplo: Leyes sobre orientaci√≥n sexual en el mundo en 2020

Tema: [Sexual orientation laws](https://ilga.org/es/mapas-legislacion-sobre-orientacion-sexual)

[Reporte en pdf](https://ilga.org/downloads/ILGA_Mundo_Homofobia_de_Estado_Actualizacion_Panorama_global_Legislacion_diciembre_2020.pdf)

[Datos en formato csv (Kaggle)](https://www.kaggle.com/datasets/mpwolke/cusersmarildownloadsomophobiacsv)

[Datos originales en formato xlsx](https://ilga.org/downloads/ILGA_State_Sponsored_Homophobia_2020_dataset.xlsx)

```{r}
leyes <- read_csv2("homophobia.csv", show_col_types = FALSE)


leyes <- leyes %>% mutate_if(is.character, factor)

# En cu√°ntos pa√≠ses son legales los actos sexuales consensuales entre personas adultas del mismo sexo (ASCAMS)
leyes %>%
  count(`CSSSA LEGAL?`)


ggplot(leyes, aes(`CSSSA LEGAL?`)) +
  geom_bar()

```


### Ordenando y visualizando datos sobre la descriminalizaci√≥n

`MAX PENALTY` indica la m√°xima cantidad de a√±os de prisi√≥n por delitos en relaci√≥n a ASCAMS. Tambi√©n incluye otras categor√≠as como pena de muerte, indeterminado, variable y "-" (no aplica, es decir, no se criminalizan).

```{r}
# No est√° ordenado de forma √∫til  
levels(leyes$`MAX PENALTY`)

# En orden de aparici√≥n en el dataset, no muy claro
leyes %>% 
  count(`MAX PENALTY`) 


# En orden de frecuencia
leyes %>% 
  mutate(`MAX PENALTY` = `MAX PENALTY` %>% fct_infreq()) %>%
  count(`MAX PENALTY`) 


# En orden num√©rico
leyes %>% 
  mutate(`MAX PENALTY` = `MAX PENALTY` %>% fct_inseq()) %>%
  count(`MAX PENALTY`) 
```

Pero "-" son los pa√≠ses que no criminalizan (sin pena), por lo tanto ser√≠a razonable **que est√©n al comienzo**. Para esto podemos usar `relevel()`:

```{r}
# En orden num√©rico, con "-" al comienzo
leyes %>% 
  mutate(`MAX PENALTY` = `MAX PENALTY` %>% fct_inseq() %>% relevel(`MAX PENALTY`,ref="-")) %>%
  count(`MAX PENALTY`) 

```

Los valores `DEATH` y `DEATH (P)` son similares: 

`DEATH`

> Pa√≠ses para los que ILGA Mundo pudo confirmar que existe certeza jur√≠dica de que la pena de muerte (PM) es el castigo
> establecido para los actos sexuales consensuales entre adultes del mismo sexo (ASCAMS)

`DEATH (P)` 
 
> Pa√≠ses para los que no existe una total certeza jur√≠dica de que la pena de muerte (PM) sea el castigo establecido para los actos
> sexuales consensuales entre personas del mismo sexo (ASCAMS)

Podemos agruparlos para simplificar la visualizaci√≥n:

```{r}
# Agrupar
leyes %>%
  mutate(`MAX PENALTY` = fct_recode(`MAX PENALTY`, 
                          "DEATH" = "DEATH", 
                          "DEATH" = "DEATH (P)")) %>%
  count(`MAX PENALTY`) 

# O simplemente
leyes %>%
  mutate(`MAX PENALTY` = fct_collapse(`MAX PENALTY`, 
                          "DEATH" = c("DEATH", "DEATH (P)"))) %>%
  count(`MAX PENALTY`) 

```


Integramos las dos modificaciones y graficamos:

```{r}
leyes %>%
  mutate(`MAX PENALTY` = `MAX PENALTY` %>% fct_inseq() %>% relevel(`MAX PENALTY`,ref="-")) %>%
  mutate(`MAX PENALTY` = fct_collapse(`MAX PENALTY`, 
                          "DEATH" = c("DEATH", "DEATH (P)"))) %>%
  count(`MAX PENALTY`)
```


```{r}
p <- leyes %>%
  mutate(`MAX PENALTY` = `MAX PENALTY` %>% fct_inseq() %>% relevel(`MAX PENALTY`,ref="-")) %>%
  mutate(`MAX PENALTY` = fct_collapse(`MAX PENALTY`, 
                          "DEATH" = c("DEATH", "DEATH (P)"))) %>%
  ggplot(aes(`MAX PENALTY`)) +
  geom_bar()
  
p
```





**PREGUNTA: ¬øC√≥mo podemos mejorar este gr√°fico? _(Similar a Ejercicio 15.3.1.1)_ üí¨**



```{r soluci√≥n}
#
#
#
#
#
#
# SPOILER
#
# SOLUCI√ìN:
#
#
#
#
#
#
```

Varias soluciones posibles^[[https://jrnold.github.io/r4ds-exercise-solutions/factors.html](https://jrnold.github.io/r4ds-exercise-solutions/factors.html)]:


Alternativa 1:

```{r}
p <- p + theme(axis.text.x = element_text(angle = 45, hjust = 1))
p
```


Alternativa 2:

```{r}
p <- p + coord_flip()
  
p
```






## Volviendo al ejemplo de lenguajes de programaci√≥n

Usando `niveles_lenguajes` y `lenguajes2` (del ejemplo de creaci√≥n de factores):

**PREGUNTA: ¬øC√≥mo podemos hacer que las distintas denominaciones de C# sean consideradas equivalentes en el factor? üí¨**

```{r}
# Actualmente todas las formas de escribir C# son consideradas valores diferentes
unique(lenguajes2)

# Si queremos interpretarlo como factor, hay valores que producen NA
unique(lenguajes2_factor)

```

Soluci√≥n:

```{r solucion}
#
#
#
#
#
#
# SPOILER
#
# SOLUCI√ìN:
#
#
#
#
#
#

lenguajes2_corregido <- fct_collapse(lenguajes2, "C#" = c("C Sharp", "C-sharp", "C#", "C‚ôØ"))

# Ahora la denominaci√≥n es uniforme
lenguajes2_corregido


```



